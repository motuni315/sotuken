<!DOCTYPE html>
<html lang="ja">
<head>
    <title>落とし物検索</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqHlGwfNy0uPR4h0GakNZW16cRtHr1cWg&callback=initMap"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
        }

        ul#item-list {
            list-style: none;
            padding: 0;
        }

        ul#item-list li {
            margin-bottom: 20px;
        }

        ul#item-list img {
            max-width: 100px;
            max-height: 100px;
            display: block;
        }
    </style>
</head>
<body>
<h1>落とし物検索</h1>

<!-- 検索フォーム -->
<form onsubmit="fetchItems(); return false;">
    <label for="item_name">品名:</label>
    <input type="text" id="item_name" name="item_name">

    <label for="prefecture">都道府県:</label>
    <select id="prefecture" name="prefecture">
      <option value="">都道府県を選択</option>
      <option value="北海道">北海道</option>
      <option value="青森">青森県</option>
      <option value="岩手">岩手県</option>
      <option value="宮城">宮城県</option>
      <option value="秋田">秋田県</option>
      <option value="山形">山形県</option>
      <option value="福島">福島県</option>
      <option value="茨城">茨城県</option>
      <option value="栃木">栃木県</option>
      <option value="群馬">群馬県</option>
      <option value="埼玉">埼玉県</option>
      <option value="千葉">千葉県</option>
      <option value="東京">東京都</option>
      <option value="神奈川">神奈川県</option>
      <option value="新潟">新潟県</option>
      <option value="富山">富山県</option>
      <option value="石川">石川県</option>
      <option value="福井">福井県</option>
      <option value="山梨">山梨県</option>
      <option value="長野">長野県</option>
      <option value="岐阜">岐阜県</option>
      <option value="静岡">静岡県</option>
      <option value="愛知">愛知県</option>
      <option value="三重">三重県</option>
      <option value="滋賀">滋賀県</option>
      <option value="京都">京都府</option>
      <option value="大阪">大阪府</option>
      <option value="兵庫">兵庫県</option>
      <option value="奈良">奈良県</option>
      <option value="和歌山">和歌山県</option>
      <option value="鳥取">鳥取県</option>
      <option value="島根">島根県</option>
      <option value="岡山">岡山県</option>
      <option value="広島">広島県</option>
      <option value="山口">山口県</option>
      <option value="徳島">徳島県</option>
      <option value="香川">香川県</option>
      <option value="愛媛">愛媛県</option>
      <option value="高知">高知県</option>
      <option value="福岡">福岡県</option>
      <option value="佐賀">佐賀県</option>
      <option value="長崎">長崎県</option>
      <option value="熊本">熊本県</option>
      <option value="大分">大分県</option>
      <option value="宮崎">宮崎県</option>
      <option value="鹿児島">鹿児島県</option>
      <option value="沖縄">沖縄県</option>
    </select>
    
    <label for="date">日時:</label>
    <input type="datetime-local" id="start_date" name="start_date"> 〜
    <input type="datetime-local" id="end_date" name="end_date">
    <button type="submit">検索</button>
</form>

<!-- 検索URLのための隠しフィールド -->
<input type="hidden" id="search-url" value="{% url 'search_items' %}">

<!-- 地図の表示部分 -->
<div id="map"></div>

<!-- 検索結果のリスト -->
<ul id="item-list"></ul>

<script>
    let map;
    let markers = [];
    let infoWindows = [];
    let currentLocation = null;

    function initMap() {
        // 最初に地図を初期化
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 14,  // 初期ズームレベル
            mapTypeId: 'roadmap'
        });

        // 現在地を取得して100m以内のアイテムを表示
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                map.setCenter(currentLocation);  // 地図の中心を現在地に設定
                map.setZoom(16);  // ズームレベルを少し近づける

                // 現在地を地図にマーカーとして表示
                const currentMarker = new google.maps.Marker({
                    position: currentLocation,
                    map: map,
                    title: '現在地'
                });

                // 現在地から100m以内のアイテムを表示
                fetchNearbyItems(currentLocation);
            });
        } else {
            alert("Geolocation is not supported by this browser.");
        }
    }

    function fetchNearbyItems(location) {
        const url = `{% url 'search_items' %}?latitude=${location.lat}&longitude=${location.lng}&radius=100`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                clearMarkers();
                if (data.length > 0) {
                    displayItems(data);
                    updateItemList(data);
                } else {
                    alert("100m以内に該当するアイテムはありません。");
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function fetchItems() {
        const itemName = document.getElementById('item_name').value;
        const prefecture = document.getElementById('prefecture').value;
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        let url = document.getElementById('search-url').value + `?item_name=${itemName}&prefecture=${prefecture}`;
        
        if (startDate) {
            url += `&start_date=${startDate}`;
        }
        if (endDate) {
            url += `&end_date=${endDate}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                clearMarkers();
                if (data.length > 0) {
                    displayItems(data);
                    updateItemList(data);
                } else {
                    alert("該当するアイテムがありません。");
                    document.getElementById('item-list').innerHTML = '<li>該当するアイテムがありません。</li>';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function displayItems(items) {
        items.forEach((item, index) => {
            if (item.latitude && item.longitude) {
                const latLng = new google.maps.LatLng(item.latitude, item.longitude);
                const marker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: item.description
                });
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div>
                            <img src="${item.image_url || ''}" alt="Lost Item" style="width:auto;height:auto;">
                            <p><strong>${item.description}</strong></p>
                        </div>`
                });
                marker.addListener('click', () => {
                    infoWindows.forEach(iw => iw.close());
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
                infoWindows.push(infoWindow);
            }
        });
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        infoWindows = [];
        document.getElementById('item-list').innerHTML = '';
    }

    function updateItemList(items) {
        const itemList = document.getElementById('item-list');
        itemList.innerHTML = '';

        items.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div>
                    ${item.image_url ? `<img src="${item.image_url}" alt="Image" onclick="focusMarker(${index}); return false;">` : ''}
                    <p>品目：${item.description}</p>
                    <p>場所: ${item.prefecture}</p>
                    <p>時間: ${item.date_time}</p>
                </div>
            `;
            itemList.appendChild(li);
        });
    }

    function focusMarker(index) {
        const marker = markers[index];
        const infoWindow = infoWindows[index];
        map.panTo(marker.getPosition());
        map.setZoom(16);
        infoWindows.forEach(iw => iw.close());
        infoWindow.open(map, marker);
    }

    window.onload = initMap;
</script>
</body>
</html>
